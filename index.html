<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestor de Estacionamiento</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="wrap">
    <!-- ===== Top: Ingreso + KPIs ===== -->
    <header class="top">
      <div class="ingreso-card card">
        <h2>Ingreso de Vehículo</h2>
        <form id="ingresoForm" autocomplete="off">
          <div class="fields">
            <div class="field">
              <label for="placa">Patente</label>
              <input id="placa" type="text" placeholder="ABC123 / AA123BB" required />
            </div>
            <div class="field">
              <label>Tipo</label>
              <div class="segmented" id="tipoGrp">
                <button type="button" class="seg active" data-tipo="auto">🚗 Auto</button>
                <button type="button" class="seg" data-tipo="camioneta">🚐 Camioneta</button>
                <button type="button" class="seg" data-tipo="moto">🏍️ Moto</button>
              </div>
            </div>
            <div class="field">
              <label for="notas">Notas (opcional)</label>
              <input id="notas" type="text" placeholder="Color, cochera, etc." />
            </div>
          </div>
          <button class="btn-primary" id="btnEntrada" type="submit">Registrar Entrada</button>
        </form>
      </div>

      <div class="kpis">
        <div class="kpi card">
          <div class="kpi-head">
            <span class="kpi-title">Espacios Totales</span>
            <span class="kpi-ico">🅿️</span>
          </div>
          <div class="kpi-val" id="kpiTotal">50</div>
          <div class="kpi-sub">Capacidad máxima</div>
        </div>

        <div class="kpi card">
          <div class="kpi-head">
            <span class="kpi-title">Ocupados</span>
            <span class="kpi-ico">↗︎</span>
          </div>
          <div class="kpi-val" id="kpiOcupados">0</div>
          <div class="kpi-sub" id="kpiOcupacion">0% ocupación</div>
        </div>

        <div class="kpi card">
          <div class="kpi-head">
            <span class="kpi-title">Disponibles</span>
            <span class="kpi-ico green">↙︎</span>
          </div>
          <div class="kpi-val green" id="kpiLibres">50</div>
          <div class="kpi-sub">Espacios libres</div>
        </div>
      </div>
    </header>

    <!-- ===== Lista ===== -->
    <main class="main card">
      <div class="main-head">
        <h1>Vehículos Estacionados</h1>
        <div class="muted" id="countLabel">Mostrando 0 vehículos</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>Patente</th>
            <th>Tipo</th>
            <th>Hora de Entrada</th>
            <th>Duración</th>
            <th class="right">Acción</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    // ===== Config =====
    const CAPACIDAD_TOTAL = 50; // podés cambiarlo

    // ===== Estado Local =====
    const LS_KEY = 'parking_entries';
    const $ = sel => document.querySelector(sel);

    let entries = loadEntries(); // [{id, placa, tipo, notas, entradaISO}]

    // ===== UI refs =====
    const form = $('#ingresoForm');
    const placaInput = $('#placa');
    const notasInput = $('#notas');
    const tipoGrp = $('#tipoGrp');
    const tbody = $('#tbody');

    const kpiTotal = $('#kpiTotal');
    const kpiOcupados = $('#kpiOcupados');
    const kpiLibres = $('#kpiLibres');
    const kpiOcupacion = $('#kpiOcupacion');
    const countLabel = $('#countLabel');

    // set KPIs base
    kpiTotal.textContent = CAPACIDAD_TOTAL;

    // ===== Helpers =====
    function loadEntries(){
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
      catch { return []; }
    }
    function saveEntries(){
      localStorage.setItem(LS_KEY, JSON.stringify(entries));
    }
    function uid(){ return Math.random().toString(36).slice(2,9) + Date.now().toString(36).slice(4); }

    function selectedTipo(){
      const btn = tipoGrp.querySelector('.seg.active');
      return btn ? btn.dataset.tipo : 'auto';
    }

    function setTipo(tipo){
      tipoGrp.querySelectorAll('.seg').forEach(b => b.classList.toggle('active', b.dataset.tipo===tipo));
    }

    function formatDate(dt){
      return dt.toLocaleString([], { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }
    function formatHM(min){
      const h = Math.floor(min/60), m = min%60;
      if(h && m) return `${h} minutos`.replace('minutos', 'h') + ` ${m} min`.replace('h', ' h');
      if(h) return `${h} h`;
      if(m<=0) return 'menos de un minuto';
      return `${m} minutos`.replace('minutos','min');
    }
    function minutesSince(iso){
      const d = new Date(iso);
      const now = new Date();
      return Math.max(0, Math.floor((now - d)/60000));
    }

    // ===== Render =====
    function render(){
      // tabla
      tbody.innerHTML = '';
      const sorted = [...entries].sort((a,b)=> (new Date(b.entradaISO)) - (new Date(a.entradaISO)));

      sorted.forEach(e => {
        const tr = document.createElement('tr');

        // patente
        const tdPlaca = document.createElement('td');
        tdPlaca.textContent = e.placa;

        // tipo badge
        const tdTipo = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = `badge ${e.tipo}`;
        badge.textContent = (e.tipo==='camioneta'?'Camioneta': e.tipo==='moto'?'Moto':'Auto');
        tdTipo.appendChild(badge);

        // entrada
        const tdEntrada = document.createElement('td');
        tdEntrada.textContent = formatDate(new Date(e.entradaISO));

        // duración (dinámica)
        const tdDur = document.createElement('td');
        const updateDur = () => {
          const m = minutesSince(e.entradaISO);
          tdDur.textContent = formatHM(m);
        };
        updateDur();
        tr._updateDur = updateDur; // guardo para el refresco global

        // acción
        const tdAcc = document.createElement('td');
        tdAcc.className = 'right';
        const btn = document.createElement('button');
        btn.className = 'btn-dark';
        btn.textContent = 'Registrar Salida';
        btn.addEventListener('click', () => removeEntry(e.id));
        tdAcc.appendChild(btn);

        tr.append(tdPlaca, tdTipo, tdEntrada, tdDur, tdAcc);
        tbody.appendChild(tr);
      });

      // KPIs
      const ocup = entries.length;
      const libres = Math.max(0, CAPACIDAD_TOTAL - ocup);
      const ocupPercent = CAPACIDAD_TOTAL ? Math.round(ocup*100/CAPACIDAD_TOTAL) : 0;

      kpiOcupados.textContent = ocup;
      kpiLibres.textContent = libres;
      kpiOcupacion.textContent = `${ocupPercent}% ocupación`;

      countLabel.textContent = `Mostrando ${entries.length} vehículo${entries.length===1?'':'s'}`;
    }

    // refresco de duraciones cada 30s
    setInterval(() => {
      tbody.querySelectorAll('tr').forEach(tr => tr._updateDur && tr._updateDur());
    }, 30000);

    // ===== Eventos =====
    // toggle tipo
    tipoGrp.addEventListener('click', (e) => {
      const btn = e.target.closest('.seg');
      if(!btn) return;
      setTipo(btn.dataset.tipo);
    });

    // submit
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const placa = (placaInput.value || '').trim().toUpperCase();
      if(!placa){ placaInput.focus(); return; }

      const entry = {
        id: uid(),
        placa,
        tipo: selectedTipo(),
        notas: (notasInput.value||'').trim(),
        entradaISO: new Date().toISOString()
      };
      entries.push(entry);
      saveEntries();
      render();

      // reset UI (vuelve a Auto)
      form.reset();
      setTipo('auto');
      placaInput.focus();
    });

    // Enter en patente también registra
    placaInput.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        $('#btnEntrada').click();
      }
    });

    function removeEntry(id){
      entries = entries.filter(x => x.id !== id);
      saveEntries();
      render();
    }

    // ===== Init =====
    setTipo('auto');
    render();
  </script>
</body>
</html>
