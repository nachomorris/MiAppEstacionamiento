<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestor de Estacionamiento â€” Local</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap-bg">
    <div class="container">
      <!-- Topbar (sin tarifas) -->
      <div class="topbar">
        <h1 class="brand">Gestor de Estacionamiento</h1>
      </div>

      <!-- KPIs -->
      <section class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-head">
            <h3 class="kpi-title">Espacios Totales</h3>
            <span class="kpi-ico">ğŸ…¿ï¸</span>
          </div>
          <div class="kpi-value" id="kpiTotal">50</div>
          <div class="kpi-sub">Capacidad mÃ¡xima</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-head">
            <h3 class="kpi-title">Ocupados</h3>
            <span class="kpi-ico">â†—ï¸</span>
          </div>
          <div class="kpi-value" id="kpiBusy">0</div>
          <div class="kpi-sub" id="kpiBusyPct">0% ocupaciÃ³n</div>
        </div>

        <div class="kpi-card kpi-available">
          <div class="kpi-head">
            <h3 class="kpi-title">Disponibles</h3>
            <span class="kpi-ico">â†™ï¸</span>
          </div>
          <div class="kpi-value kpi-value-green" id="kpiFree">50</div>
          <div class="kpi-sub">Espacios libres</div>
        </div>
      </section>

      <!-- Form + Lista -->
      <section class="grid">
        <!-- Alta -->
        <div class="card">
          <h3 class="card-title">Ingreso de vehÃ­culo</h3>

          <div class="field">
            <label for="placa">Patente</label>
            <input id="placa" type="text" placeholder="Ej: ABC123 / AB123CD" autocomplete="off">
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="hora">Hora (auto)</label>
              <input id="hora" type="text" readonly>
            </div>
            <div class="field">
              <label for="notas">Notas (opcional)</label>
              <input id="notas" type="text" placeholder="Color, lugar, etc.">
            </div>
          </div>

          <div class="vehicle-group">
            <button class="vehicle-btn active" data-tipo="auto">ğŸš—</button>
            <button class="vehicle-btn" data-tipo="camioneta">ğŸš</button>
            <button class="vehicle-btn" data-tipo="moto">ğŸï¸</button>
          </div>

          <button id="btnEntrada" class="btn-primary">Entrada</button>
        </div>

        <!-- Lista -->
        <div class="card">
          <div class="list-head">
            <h3 class="card-title">Estacionados</h3>
            <span class="badge" id="badgeCount">0</span>
          </div>

          <div class="search-row">
            <input id="searchInput" type="text" placeholder="BUSCAR PATENTE">
            <button id="clearFilter" class="btn-chip" style="display:none;">Borrar filtro</button>
          </div>

          <ul class="list" id="lista"></ul>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    // ====== Estado Local ======
    const KEY_CAPACITY = 'parking.capacity';
    const KEY_DATA     = 'parking.estacionados';

    let capacity   = Number(localStorage.getItem(KEY_CAPACITY) || 50);
    let items      = JSON.parse(localStorage.getItem(KEY_DATA) || '[]'); // [{id, placa, tipo, notas, entradaISO}]
    let tipoSel    = 'auto';

    // ====== Refs ======
    const $ = (id) => document.getElementById(id);
    const placaEl = $('placa');
    const notasEl = $('notas');
    const horaEl  = $('hora');
    const btn     = $('btnEntrada');
    const listaEl = $('lista');
    const badgeEl = $('badgeCount');
    const search  = $('searchInput');
    const clearF  = $('clearFilter');

    const kpiTotal = $('kpiTotal');
    const kpiBusy  = $('kpiBusy');
    const kpiFree  = $('kpiFree');
    const kpiPct   = $('kpiBusyPct');

    // ====== UI helpers ======
    function toast(msg){
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }
    function nowText(){
      return new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit', hour12:false});
    }
    function updateClock(){
      horaEl.value = nowText();
    }
    setInterval(updateClock, 60_000);
    updateClock();

    // ====== Persistencia ======
    function save(){
      localStorage.setItem(KEY_CAPACITY, String(capacity));
      localStorage.setItem(KEY_DATA, JSON.stringify(items));
    }

    // ====== KPIs ======
    function renderKpis(){
      const busy = items.length;
      const free = Math.max(0, capacity - busy);
      const pct  = capacity ? Math.round((busy / capacity)*100) : 0;

      kpiTotal.textContent = capacity;
      kpiBusy.textContent  = busy;
      kpiFree.textContent  = free;
      kpiPct.textContent   = `${pct}% ocupaciÃ³n`;
      badgeEl.textContent  = busy;
    }

    // ====== Lista ======
    function renderList(){
      const term = (search.value || '').trim().toUpperCase();
      const data = term ? items.filter(v => (v.placa||'').toUpperCase().includes(term)) : items;

      listaEl.innerHTML = '';
      data.forEach(v=>{
        const li = document.createElement('li');

        const left = document.createElement('div');
        left.className = 'item-left';
        const emoji = v.tipo==='camioneta' ? 'ğŸš' : (v.tipo==='moto' ? 'ğŸï¸' : 'ğŸš—');

        const plate = document.createElement('div');
        plate.className = 'plate';
        plate.textContent = `${emoji} ${v.placa}`;

        const time = document.createElement('div');
        time.className = 'time';
        time.textContent = new Date(v.entradaISO).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        left.appendChild(plate);
        left.appendChild(time);
        if (v.notas){
          const n = document.createElement('div');
          n.className = 'note';
          n.textContent = v.notas;
          left.appendChild(n);
        }

        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.textContent = 'SALIDA';
        del.addEventListener('click', ()=>{
          items = items.filter(x => x.id !== v.id);
          save();
          renderKpis();
          renderList();
          toast('Salida confirmada');
        });

        li.appendChild(left);
        li.appendChild(del);
        listaEl.appendChild(li);
      });
    }

    // ====== Filtro ======
    function toggleClear(){
      clearF.style.display = (search.value || '').trim().length ? 'inline-flex' : 'none';
    }
    search.addEventListener('input', ()=>{ toggleClear(); renderList(); });
    clearF.addEventListener('click', ()=>{ search.value=''; toggleClear(); renderList(); });
    toggleClear();

    // ====== Tipo seleccionado ======
    document.querySelectorAll('.vehicle-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.vehicle-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        tipoSel = btn.dataset.tipo;
      });
    });

    // ====== Entrada ======
    function addEntrada(){
      const placa = (placaEl.value || '').trim().toUpperCase();
      if (!placa){ toast('IngresÃ¡ la patente'); placaEl.focus(); return; }

      if (items.length >= capacity){
        toast('Capacidad completa');
        return;
      }

      const id = crypto.randomUUID();
      items.unshift({
        id,
        placa,
        tipo: tipoSel,
        notas: (notasEl.value || '').trim(),
        entradaISO: new Date().toISOString()
      });
      save();
      renderKpis();
      renderList();

      // reset UI + volver a auto
      placaEl.value=''; notasEl.value='';
      document.querySelectorAll('.vehicle-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.vehicle-btn[data-tipo="auto"]').classList.add('active');
      tipoSel = 'auto';

      placaEl.focus();
      toast('VehÃ­culo ingresado');
    }
    btn.addEventListener('click', (e)=>{ e.preventDefault(); addEntrada(); });
    placaEl.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addEntrada(); } });

    // ====== Init ======
    renderKpis();
    renderList();
  </script>
</body>
</html>
